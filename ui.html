<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Agent</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      overflow: hidden;
      background-color: #1a1a1a;
      color: #fff;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    /* Left Control Panel */
    .control-panel {
      width: 400px;
      background-color: #2a2a2a;
      border-right: 1px solid #3a3a3a;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 20px;
      background-color: #4361ee;
      text-align: center;
    }

    .header h1 {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      min-height: 0; /* Allow flex child to shrink below content size */
      display: flex;
      flex-direction: column;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #aaa;
    }

    select {
      width: 100%;
      padding: 12px;
      background-color: #1a1a1a;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #4361ee;
    }

    select option {
      background-color: #1a1a1a;
      color: #fff;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      background-color: #1a1a1a;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: #4361ee;
    }

    .btn {
      width: 100%;
      padding: 12px;
      background-color: #4361ee;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      flex-shrink: 0; /* Don't shrink buttons */
    }

    .btn:hover:not(:disabled) {
      background-color: #3a56d4;
    }

    .btn:disabled {
      background-color: #555;
      cursor: not-allowed;
    }

    .btn-stop {
      background-color: #f44336;
      margin-top: 10px;
    }

    .btn-stop:hover:not(:disabled) {
      background-color: #d32f2f;
    }

    .status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      display: none;
      flex-shrink: 0; /* Don't shrink status message */
    }

    .status.show {
      display: block;
    }

    .status.success {
      background-color: rgba(76, 175, 80, 0.2);
      border: 1px solid #4caf50;
      color: #4caf50;
    }

    .status.error {
      background-color: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      color: #f44336;
    }

    .status.info {
      background-color: rgba(33, 150, 243, 0.2);
      border: 1px solid #2196f3;
      color: #2196f3;
    }

    /* Right Live View */
    .live-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #000;
      min-width: 0; /* prevent horizontal overflow from long children */
    }

    .live-header {
      padding: 15px 20px;
      background-color: #2a2a2a;
      border-bottom: 1px solid #3a3a3a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .live-header h2 {
      font-size: 1.2rem;
    }

    .indicator {
      font-size: 0.9rem;
      color: #888;
    }

    .indicator.active {
      color: #4caf50;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .screenshot-area {
      flex: 1;
      position: relative;
      overflow: auto;
      background-color: #000;
      min-height: 0;
      min-width: 0; /* allow child to shrink and center properly */
      cursor: zoom-in;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .screenshot-area.zoomed {
      cursor: zoom-out;
      overflow: auto;
    }

    .screenshot-img {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      object-position: center;
      display: block;
      image-rendering: auto;
      transition: transform 0.3s ease;
    }

    .screenshot-area.zoomed .screenshot-img {
      transform: scale(2);
      transform-origin: center center;
    }

    .placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #555;
    }

    .placeholder h3 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .url-bar {
      padding: 10px 20px;
      background-color: #2a2a2a;
      border-top: 1px solid #3a3a3a;
      font-family: monospace;
      font-size: 0.85rem;
      color: #4caf50;
      display: none;
      max-width: 100%;
      overflow: hidden;            /* avoid expanding layout horizontally */
      white-space: normal;         /* allow wrapping */
      word-break: break-all;       /* break long URLs */
      overflow-wrap: anywhere;     /* robust wrapping for long tokens */
    }

    .url-bar.show {
      display: block;
    }

    .logs {
      flex: 0 1 auto; /* Allow to shrink, don't grow beyond max-height */
      max-height: 200px;
      overflow-y: auto;
      background-color: #1a1a1a;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      padding: 10px;
      margin-top: 15px;
      font-size: 0.85rem;
      font-family: monospace;
      transition: max-height 0.3s ease, flex 0.3s ease;
      min-height: 100px; /* Minimum height for logs */
    }

    .logs.expanded {
      flex: 1 1 auto; /* Expand to fill available space in parent */
      max-height: none; /* Remove max-height constraint when expanded */
    }

    .form-inputs {
      transition: opacity 0.3s ease, max-height 0.3s ease;
      overflow: hidden;
      flex-shrink: 0; /* Don't shrink form inputs */
    }

    .form-inputs.hidden {
      opacity: 0;
      max-height: 0;
      margin: 0;
      padding: 0;
    }

    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid #2a2a2a;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: #888;
    }

    .log-message {
      color: #aaa;
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      flex-shrink: 0; /* Don't shrink log header */
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Left Control Panel -->
    <div class="control-panel">
      <div class="header">
        <h1>Web AI-Agent</h1>
        <p>Web Automation with GPT</p>
      </div>

      <div class="content">
        <div id="formInputs" class="form-inputs">
          <div class="form-group">
            <label for="modelSelect">AI Model</label>
            <select id="modelSelect">
              <option value="gpt-5-mini" selected>GPT-5 Mini (Fast & Efficient)</option>
              <option value="gpt-5-nano">GPT-5 Nano (Ultra Fast)</option>
              <option value="gpt-5">GPT-5 (Most Capable)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="captchaVisionModel">Captcha Vision Model</label>
            <select id="captchaVisionModel">
              <option value="gpt-5" selected>GPT-5 (Vision)</option>
              <option value="gpt-5-mini">GPT-5 Mini (Vision-lite)</option>
              <option value="gpt-5-nano">GPT-5 Nano (Fast, may be limited)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="taskInput">Task Instructions</label>
            <textarea
              id="taskInput"
              placeholder="Example: Go to Google and search for OpenAI"
            ></textarea>
          </div>
        </div>

        <button id="runBtn" class="btn">Run Task</button>
        <button id="stopBtn" class="btn btn-stop" style="display: none;">Stop Task</button>

        <div id="status" class="status"></div>

        <div class="log-header">
          <h3 style="font-size: 0.9rem; color: #aaa; margin: 0;">Logs</h3>
          <button id="copyLogsBtn" class="btn" style="width: auto; padding: 6px 12px; font-size: 0.85rem; background-color: #555;">Copy Logs</button>
        </div>
        <div class="logs" id="logs"></div>
      </div>
    </div>

    <!-- Right Live View -->
    <div class="live-view">
      <div class="live-header">
        <h2>üåê Live View</h2>
        <span id="indicator" class="indicator">‚óã Idle</span>
      </div>

      <div class="screenshot-area" id="screenshotArea">
        <img id="liveImage" class="screenshot-img" alt="Screenshot" style="display:none;" />
        <div id="placeholder" class="placeholder">
          <h3>üì∏</h3>
          <p>Run a task to see the live browser view</p>
        </div>
      </div>

      <div id="urlBar" class="url-bar"></div>
    </div>
  </div>

  <script>
    const modelSelect = document.getElementById('modelSelect');
    const taskInput = document.getElementById('taskInput');
    const runBtn = document.getElementById('runBtn');
    const stopBtn = document.getElementById('stopBtn');
    const formInputs = document.getElementById('formInputs');
    const status = document.getElementById('status');
    const indicator = document.getElementById('indicator');
    const screenshotArea = document.getElementById('screenshotArea');
    const urlBar = document.getElementById('urlBar');
    const logs = document.getElementById('logs');
    const captchaVisionModel = document.getElementById('captchaVisionModel');

    let isRunning = false;

    // Show status message
    function showStatus(message, type = 'info') {
      status.textContent = message;
      status.className = `status show ${type}`;
    }

    // Add log entry
    function addLog(message) {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const time = new Date().toLocaleTimeString();
      entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-message">${message}</span>`;
      logs.appendChild(entry);
      logs.scrollTop = logs.scrollHeight;
    }

    // Show report in Live View
    function showReportInLiveView(reportText) {
      const img = document.getElementById('liveImage');
      const placeholder = document.getElementById('placeholder');

      // Ïù¥ÎØ∏ÏßÄ Ïà®ÍπÄ
      if (img) img.style.display = 'none';
      if (placeholder) placeholder.style.display = 'none';

      // Í∏∞Ï°¥ Î≥¥Í≥†ÏÑú Ï†úÍ±∞
      const existingReport = document.getElementById('reportContainer');
      if (existingReport) existingReport.remove();

      // Î≥¥Í≥†ÏÑú Ïª®ÌÖåÏù¥ÎÑà ÏÉùÏÑ±
      const reportContainer = document.createElement('div');
      reportContainer.id = 'reportContainer';
      reportContainer.style.cssText = `
        padding: 30px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #333;
        line-height: 1.6;
        overflow-y: auto;
        max-height: 100%;
      `;

      // Î≥¥Í≥†ÏÑú Ï†úÎ™©
      const title = document.createElement('h2');
      title.textContent = 'üìã ÏûëÏóÖ ÏôÑÎ£å Î≥¥Í≥†ÏÑú';
      title.style.cssText = `
        color: #2563eb;
        border-bottom: 3px solid #2563eb;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 24px;
      `;
      reportContainer.appendChild(title);

      // Î≥¥Í≥†ÏÑú ÎÇ¥Ïö© (Ï§ÑÎ∞îÍøà Î∞è Ìè¨Îß∑ Ïú†ÏßÄ)
      const content = document.createElement('div');
      content.style.cssText = `
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 15px;
      `;
      content.textContent = reportText;
      reportContainer.appendChild(content);

      // Live ViewÏóê Ï∂îÍ∞Ä
      screenshotArea.appendChild(reportContainer);

      // URL Î∞î ÏóÖÎç∞Ïù¥Ìä∏
      urlBar.textContent = 'ÏûëÏóÖ ÏôÑÎ£å - Î≥¥Í≥†ÏÑú';
      urlBar.classList.add('show');

      // Î°úÍ∑∏ÏóêÎèÑ Ï∂îÍ∞Ä
      addLog('Î≥¥Í≥†ÏÑúÍ∞Ä Live ViewÏóê ÌëúÏãúÎêòÏóàÏäµÎãàÎã§.');
    }

    // Run task
    runBtn.addEventListener('click', async () => {
      const task = taskInput.value.trim();
      const model = modelSelect.value;

      if (!task) {
        showStatus('Please enter task instructions', 'error');
        return;
      }

      if (isRunning) {
        showStatus('A task is already running', 'error');
        return;
      }

      runBtn.disabled = true;
      runBtn.style.display = 'none';
      stopBtn.style.display = 'block';
      formInputs.classList.add('hidden'); // ÏûÖÎ†•ÎûÄ Ïà®ÍπÄ
      logs.classList.add('expanded'); // Î°úÍ∑∏ ÌôïÏû•
      isRunning = true;

      try {
        showStatus(`Starting task with ${model}...`, 'info');
        const settings = {
          captchaVisionModel: (captchaVisionModel && captchaVisionModel.value) || undefined
        };
        if (settings.captchaVisionModel) addLog(`Captcha Vision Model: ${settings.captchaVisionModel}`);
        const result = await window.electronAPI.runTask(task, model, settings);

        if (result.success) {
          showStatus('Task started successfully', 'success');
        } else {
          showStatus(`Error: ${result.error}`, 'error');
          // ÏóêÎü¨ Ïãú UI Î≥µÍµ¨
          runBtn.disabled = false;
          runBtn.style.display = 'block';
          stopBtn.style.display = 'none';
          formInputs.classList.remove('hidden');
          logs.classList.remove('expanded');
          isRunning = false;
        }
      } catch (error) {
        showStatus(`Error: ${error.message}`, 'error');
        // ÏóêÎü¨ Ïãú UI Î≥µÍµ¨
        runBtn.disabled = false;
        runBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        formInputs.classList.remove('hidden');
        logs.classList.remove('expanded');
        isRunning = false;
      }
    });

    // Copy logs
    const copyLogsBtn = document.getElementById('copyLogsBtn');
    copyLogsBtn.addEventListener('click', () => {
      const logText = Array.from(logs.children)
        .map(entry => entry.textContent)
        .join('\n');
      navigator.clipboard.writeText(logText).then(() => {
        showStatus('Logs copied to clipboard', 'success');
        setTimeout(() => showStatus('Ready', 'success'), 2000);
      }).catch(err => {
        showStatus('Failed to copy logs', 'error');
      });
    });

    // Stop task
    stopBtn.addEventListener('click', async () => {
      if (!isRunning) return;

      stopBtn.disabled = true;
      showStatus('Stopping task...', 'info');
      addLog('Stop requested by user');

      try {
        const res = await window.electronAPI.stopTask();
        if (res && res.success) {
          // Ï¶âÏãú UI Î≥µÍµ¨
          indicator.textContent = '‚óã Idle';
          indicator.classList.remove('active');
          runBtn.disabled = false;
          runBtn.style.display = 'block';
          stopBtn.style.display = 'none';
          formInputs.classList.remove('hidden');
          logs.classList.remove('expanded');
          isRunning = false;
          showStatus('Task stopped by user', 'success');
        } else {
          showStatus('No running task to stop', 'error');
        }
      } catch (error) {
        showStatus(`Error stopping task: ${error.message}`, 'error');
      } finally {
        stopBtn.disabled = false;
      }
    });

    // Zoom toggle for screenshot area (click to toggle 2x zoom)
    screenshotArea.addEventListener('click', (e) => {
      if (e.target === screenshotArea || e.target.id === 'liveImage') {
        screenshotArea.classList.toggle('zoomed');
      }
    });

    // Mouse wheel zoom (Ctrl+Wheel for fine control)
    let zoomLevel = 1;
    screenshotArea.addEventListener('wheel', (e) => {
      if (e.ctrlKey) {
        e.preventDefault();
        const img = document.getElementById('liveImage');
        if (!img || img.style.display === 'none') return;

        const delta = e.deltaY < 0 ? 0.1 : -0.1;
        zoomLevel = Math.min(Math.max(0.5, zoomLevel + delta), 5);

        img.style.transform = `scale(${zoomLevel})`;

        // Update cursor
        screenshotArea.style.cursor = zoomLevel > 1 ? 'zoom-out' : 'zoom-in';
      }
    }, { passive: false });

    // Electron event listeners
    if (window.electronAPI) {
      // Task started
      window.electronAPI.onAgentStarted((data) => {
        indicator.textContent = '‚óè Running';
        indicator.classList.add('active');
        showStatus(`Task started: ${data.task}`, 'info');
        addLog(`Task started: ${data.task}`);
      });

      // Screenshot update
      window.electronAPI.onAgentScreenshot((data) => {
        const img = document.getElementById('liveImage');
        const placeholder = document.getElementById('placeholder');
        // Reset zoom when new image arrives
        screenshotArea.classList.remove('zoomed');
        zoomLevel = 1;
        screenshotArea.style.cursor = 'zoom-in';
        // Reset scroll position to avoid right-shifted image when previous zoom/scroll remained
        screenshotArea.scrollLeft = 0;
        screenshotArea.scrollTop = 0;
        if (img) {
          img.src = `data:image/png;base64,${data.image}`;
          img.style.display = 'block';
          img.style.transform = 'scale(1)';
          if (placeholder) placeholder.style.display = 'none';
        }

        if (data.url) {
          // Wrap long URLs without causing horizontal scroll
          urlBar.textContent = data.url;
          urlBar.classList.add('show');
        }
      });

      // Log
      window.electronAPI.onAgentLog((log) => {
        if (log.type === 'system') {
          addLog(log.data.message || JSON.stringify(log.data));
        }
      });

      // Task stopped
      window.electronAPI.onAgentStopped((data) => {
        indicator.textContent = '‚óã Idle';
        indicator.classList.remove('active');
        showStatus(`Task stopped: ${data.reason}`, data.reason.includes('Error') ? 'error' : 'success');
        addLog(`Task stopped: ${data.reason}`);

        // ÏûëÏóÖ ÏôÑÎ£å Ïãú Î≥¥Í≥†ÏÑú ÌëúÏãú
        if (data.success && data.report) {
          showReportInLiveView(data.report);
        }

        // UI Î¶¨ÏÖã
        runBtn.disabled = false;
        runBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        formInputs.classList.remove('hidden'); // ÏûÖÎ†•ÎûÄ Îã§Ïãú ÌëúÏãú
        logs.classList.remove('expanded'); // Î°úÍ∑∏ Ï∂ïÏÜå
        isRunning = false;
      });

      showStatus('Ready', 'success');
    } else {
      showStatus('Electron API not found', 'error');
    }
  </script>
</body>
</html>

