<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browser Toolbar</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }

    .browser-toolbar {
      position: fixed;
      top: 36px; /* Tab bar ÏïÑÎûò */
      left: 0;
      width: 75%; /* ÏôºÏ™Ω 75% - BrowserView ÏòÅÏó≠ */
      height: 48px;
      background: #f1f3f4;
      border-bottom: 1px solid #dadce0;
      display: flex;
      align-items: center;
      padding: 0 8px;
      gap: 8px;
      z-index: 10000;
    }

    .nav-button {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5f6368;
      font-size: 18px;
      transition: background 0.2s;
    }

    .nav-button:hover:not(:disabled) {
      background: #e8eaed;
    }

    .nav-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .nav-button:active:not(:disabled) {
      background: #dadce0;
    }

    .url-container {
      flex: 1;
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid #dadce0;
      border-radius: 24px;
      padding: 0 16px;
      height: 36px;
    }

    .url-container:focus-within {
      background: white;
      box-shadow: 0 1px 6px rgba(32,33,36,.28);
    }

    .url-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      color: #202124;
      background: transparent;
    }

    .url-icon {
      margin-right: 8px;
      color: #5f6368;
      font-size: 16px;
    }

    .chat-toggle-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5f6368;
      font-size: 20px;
      transition: background 0.2s;
      margin-left: 8px;
    }

    .chat-toggle-btn:hover {
      background: #e8eaed;
    }

    /* Chat UI iframe - Ïò§Î•∏Ï™Ω 25% */
    .chat-iframe {
      position: fixed;
      right: 0;
      top: 0;
      width: 25%;
      height: 100vh;
      border: none;
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .chat-iframe.hidden {
      transform: translateX(100%);
    }

    /* Toolbar ÌÅ¨Í∏∞ Ï°∞Ï†ï - chat Ïà®Í∏∞Î©¥ 100% */
    .browser-toolbar.full-width {
      width: 100%;
    }

    /* Tab bar */
    .tab-bar {
      position: fixed;
      top: 0; /* Îß® ÏúÑ */
      left: 0;
      width: 75%;
      height: 36px;
      background: #dee1e6;
      display: flex;
      align-items: center;
      gap: 2px;
      padding: 0 4px;
      overflow-x: auto;
      overflow-y: hidden;
      z-index: 10001; /* toolbarÎ≥¥Îã§ ÏúÑ */
      transition: width 0.3s ease;
    }

    .tab-bar.full-width {
      width: 100%;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #c4c7cc;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      min-width: 150px;
      max-width: 200px;
      font-size: 13px;
      color: #3c4043;
      user-select: none;
      transition: background 0.2s;
    }

    .tab:hover {
      background: #b8bbc0;
    }

    .tab.active {
      background: #f1f3f4;
      color: #202124;
    }

    .tab-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .tab-close {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      opacity: 0.6;
      transition: opacity 0.2s, background 0.2s;
    }

    .tab-close:hover {
      opacity: 1;
      background: rgba(0,0,0,0.1);
    }

    .new-tab-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #5f6368;
      transition: background 0.2s;
    }

    .new-tab-btn:hover {
      background: rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <!-- Tab bar -->
  <div class="tab-bar" id="tabBar">
    <div class="tab active" data-tab-id="0">
      <span class="tab-title" id="tab-title-0">ÏÉà ÌÉ≠</span>
      <span class="tab-close">√ó</span>
    </div>
    <button class="new-tab-btn" id="newTabBtn">+</button>
  </div>

  <div class="browser-toolbar" id="toolbar">
    <button class="nav-button" id="backBtn" title="Îí§Î°ú Í∞ÄÍ∏∞">‚óÄ</button>
    <button class="nav-button" id="forwardBtn" title="ÏïûÏúºÎ°ú Í∞ÄÍ∏∞">‚ñ∂</button>
    <button class="nav-button" id="refreshBtn" title="ÏÉàÎ°úÍ≥†Ïπ®">‚Üª</button>

    <div class="url-container">
      <span class="url-icon">üîí</span>
      <input
        type="text"
        class="url-input"
        id="urlInput"
        placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
      />
    </div>

    <button class="chat-toggle-btn" id="chatToggleBtn" title="AI Chat Ïó¥Í∏∞/Îã´Í∏∞">üí¨</button>
  </div>

  <!-- Chat UI iframe -->
  <iframe src="browser-chat-ui.html" class="chat-iframe" id="chatIframe"></iframe>

  <script>
    const { ipcRenderer } = require('electron');

    const backBtn = document.getElementById('backBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const urlInput = document.getElementById('urlInput');
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const chatIframe = document.getElementById('chatIframe');
    const toolbar = document.getElementById('toolbar');
    const tabBar = document.getElementById('tabBar');
    const newTabBtn = document.getElementById('newTabBtn');

    let chatVisible = true;
    let currentTabId = 0;
    let tabs = [{ id: 0, title: 'ÏÉà ÌÉ≠', url: 'https://www.google.com' }];
    let nextTabId = 1;

    // Chat ÌÜ†Í∏Ä
    chatToggleBtn.addEventListener('click', () => {
      chatVisible = !chatVisible;

      if (chatVisible) {
        chatIframe.classList.remove('hidden');
        toolbar.classList.remove('full-width');
        tabBar.classList.remove('full-width');
        chatToggleBtn.textContent = 'üí¨';
        ipcRenderer.invoke('toggle-chat', { visible: true });
      } else {
        chatIframe.classList.add('hidden');
        toolbar.classList.add('full-width');
        tabBar.classList.add('full-width');
        chatToggleBtn.textContent = 'üí¨';
        ipcRenderer.invoke('toggle-chat', { visible: false });
      }
    });

    // ÌÉ≠ ÏÉùÏÑ±
    function createNewTab() {
      const tabId = nextTabId++;
      tabs.push({ id: tabId, title: 'ÏÉà ÌÉ≠', url: 'https://www.google.com' });

      const tabElement = document.createElement('div');
      tabElement.className = 'tab';
      tabElement.setAttribute('data-tab-id', tabId);
      tabElement.innerHTML = `
        <span class="tab-title" id="tab-title-${tabId}">ÏÉà ÌÉ≠</span>
        <span class="tab-close">√ó</span>
      `;

      tabElement.addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-close')) {
          closeTab(tabId);
        } else {
          switchTab(tabId);
        }
      });

      tabBar.insertBefore(tabElement, newTabBtn);
      switchTab(tabId);
    }

    // ÌÉ≠ Ï†ÑÌôò
    function switchTab(tabId) {
      currentTabId = tabId;

      // UI ÏóÖÎç∞Ïù¥Ìä∏
      document.querySelectorAll('.tab').forEach(tab => {
        if (parseInt(tab.getAttribute('data-tab-id')) === tabId) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      // ÌÉ≠ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      const tab = tabs.find(t => t.id === tabId);
      if (tab) {
        ipcRenderer.invoke('switch-tab', { tabId, url: tab.url });
      }
    }

    // ÌÉ≠ Îã´Í∏∞
    function closeTab(tabId) {
      if (tabs.length === 1) {
        alert('ÎßàÏßÄÎßâ ÌÉ≠ÏùÄ Îã´ÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        return;
      }

      // ÌÉ≠ Ï†úÍ±∞
      tabs = tabs.filter(t => t.id !== tabId);
      const tabElement = tabBar.querySelector(`[data-tab-id="${tabId}"]`);
      if (tabElement) {
        tabElement.remove();
      }

      // ÌòÑÏû¨ ÌÉ≠Ïù¥ Îã´Ìûå Í≤ΩÏö∞ Îã§Î•∏ ÌÉ≠ÏúºÎ°ú Ï†ÑÌôò
      if (currentTabId === tabId) {
        switchTab(tabs[0].id);
      }
    }

    // ÏÉà ÌÉ≠ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    newTabBtn.addEventListener('click', createNewTab);

    // Ï≤´ ÌÉ≠ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    document.querySelector('.tab').addEventListener('click', (e) => {
      if (e.target.classList.contains('tab-close')) {
        closeTab(0);
      } else {
        switchTab(0);
      }
    });

    // Îí§Î°ú Í∞ÄÍ∏∞
    backBtn.addEventListener('click', () => {
      ipcRenderer.invoke('browser-navigation', { action: 'back' });
    });

    // ÏïûÏúºÎ°ú Í∞ÄÍ∏∞
    forwardBtn.addEventListener('click', () => {
      ipcRenderer.invoke('browser-navigation', { action: 'forward' });
    });

    // ÏÉàÎ°úÍ≥†Ïπ®
    refreshBtn.addEventListener('click', () => {
      ipcRenderer.invoke('browser-navigation', { action: 'reload' });
    });

    // URL ÏûÖÎ†• (Enter ÌÇ§)
    urlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        let url = urlInput.value.trim();

        // URLÏù¥ ÏïÑÎãàÎ©¥ Google Í≤ÄÏÉâÏúºÎ°ú Ï≤òÎ¶¨
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          if (url.includes('.') && !url.includes(' ')) {
            // domain.com ÌòïÌÉúÎ©¥ https Ï∂îÍ∞Ä
            url = 'https://' + url;
          } else {
            // Í≤ÄÏÉâÏñ¥Î°ú Ï≤òÎ¶¨
            url = 'https://www.google.com/search?q=' + encodeURIComponent(url);
          }
        }

        ipcRenderer.invoke('browser-navigation', { action: 'navigate', url });
      }
    });

    // BrowserView URL Î≥ÄÍ≤Ω Ïãú Ï£ºÏÜåÏ∞Ω ÏóÖÎç∞Ïù¥Ìä∏
    ipcRenderer.on('url-changed', (event, url, title) => {
      urlInput.value = url;

      // ÌòÑÏû¨ ÌÉ≠ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
      const currentTab = tabs.find(t => t.id === currentTabId);
      if (currentTab) {
        currentTab.url = url;
        currentTab.title = title || 'ÏÉà ÌÉ≠';

        // ÌÉ≠ Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
        const tabTitleElement = document.getElementById(`tab-title-${currentTabId}`);
        if (tabTitleElement) {
          tabTitleElement.textContent = title || 'ÏÉà ÌÉ≠';
        }
      }

      // Îí§Î°ú/ÏïûÏúºÎ°ú Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      ipcRenderer.invoke('browser-can-navigate').then(({ canGoBack, canGoForward }) => {
        backBtn.disabled = !canGoBack;
        forwardBtn.disabled = !canGoForward;
      });
    });

    // Ï¥àÍ∏∞ URL Î°úÎìú
    ipcRenderer.invoke('browser-get-url').then((url) => {
      if (url) urlInput.value = url;
    });
  </script>
</body>
</html>
