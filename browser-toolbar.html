<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browser Toolbar</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }

    .browser-toolbar {
      position: fixed;
      top: 32px; /* Tab bar ë°”ë¡œ ì•„ë˜ */
      left: 0;
      width: 75%; /* ì™¼ìª½ 75% - BrowserView ì˜ì—­ */
      height: 40px;
      background: #fff;
      border-bottom: 1px solid #dadce0;
      display: flex;
      align-items: center;
      padding: 0 8px;
      gap: 8px;
      z-index: 10000;
    }

    .nav-button {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5f6368;
      font-size: 24px;
      font-weight: 300;
      transition: background 0.15s, transform 0.1s;
    }

    .nav-button:hover:not(:disabled) {
      background: #e8eaed;
      transform: scale(1.05);
    }

    .nav-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .nav-button:active:not(:disabled) {
      background: #dadce0;
      transform: scale(0.95);
    }

    .url-container {
      flex: 1;
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid #dadce0;
      border-radius: 24px;
      padding: 0 16px;
      height: 36px;
    }

    .url-container:focus-within {
      background: white;
      box-shadow: 0 1px 6px rgba(32,33,36,.28);
    }

    .url-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      color: #202124;
      background: transparent;
    }

    .url-icon {
      margin-right: 8px;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .url-icon::before {
      content: '';
      position: absolute;
      width: 10px;
      height: 12px;
      border: 2px solid #5f6368;
      border-radius: 3px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .url-icon::after {
      content: '';
      position: absolute;
      width: 6px;
      height: 4px;
      background: #5f6368;
      border-radius: 1px 1px 0 0;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
    }

    .chat-toggle-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5f6368;
      font-size: 20px;
      transition: background 0.15s, transform 0.1s;
      margin-left: 8px;
    }

    .chat-toggle-btn:hover {
      background: #e8eaed;
      transform: scale(1.1);
    }

    .chat-toggle-btn:active {
      transform: scale(0.95);
    }

    /* Chat UI iframe - ì˜¤ë¥¸ìª½ 25% */
    .chat-iframe {
      position: fixed;
      right: 0;
      top: 0; /* ë§¨ ìœ„ë¶€í„° ì‹œì‘ (ì±„íŒ… íƒ­ë°”ë„ ìƒë‹¨ 32pxì— í¬í•¨) */
      width: 25%;
      height: 100vh;
      border: none;
      z-index: 1000;
      transition: transform 0.15s ease-out, opacity 0.15s ease-out;
    }

    .chat-iframe.hidden {
      transform: translateX(100%);
      opacity: 0;
      pointer-events: none;
    }

    /* Toolbar í¬ê¸° ì¡°ì • - chat ìˆ¨ê¸°ë©´ 100% */
    .browser-toolbar.full-width {
      width: 100%;
    }

    /* Tab bar */
    .tab-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 75%;
      height: 32px;
      background: #f1f3f4;
      display: flex;
      align-items: center;
      gap: 2px;
      padding: 0 4px;
      overflow-x: auto;
      overflow-y: hidden;
      z-index: 10001;
      transition: width 0.15s ease-out;
      -webkit-app-region: drag; /* íƒ€ì´í‹€ë°”ì²˜ëŸ¼ ë“œë˜ê·¸ ê°€ëŠ¥ */
    }

    .tab-bar.full-width {
      width: 100%;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #dadce0;
      border-radius: 8px 8px 0 0;
      cursor: grab;
      min-width: 150px;
      max-width: 200px;
      font-size: 13px;
      color: #5f6368;
      user-select: none;
      transition: background 0.15s, transform 0.15s, box-shadow 0.15s;
      position: relative;
      border: 1px solid #dadce0;
      -webkit-app-region: no-drag; /* íƒ­ì€ í´ë¦­ ê°€ëŠ¥ */
      border-bottom: none;
    }

    .tab:hover {
      background: #e8eaed;
    }

    .tab.active {
      background: #fff;
      color: #202124;
      border: 1px solid #dadce0;
      border-bottom: 1px solid #fff;
      position: relative;
      z-index: 1;
    }

    .tab.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .tab.drag-over {
      transform: translateX(4px);
    }

    .tab-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .tab-close {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      opacity: 0.6;
      transition: opacity 0.2s, background 0.2s;
    }

    .tab-close:hover {
      opacity: 1;
      background: rgba(0,0,0,0.1);
    }

    .new-tab-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #3c4043;
      transition: background 0.15s, transform 0.15s;
      -webkit-app-region: no-drag; /* ë²„íŠ¼ì€ í´ë¦­ ê°€ëŠ¥ */
    }

    .new-tab-btn:hover {
      background: rgba(255,255,255,0.4);
      transform: scale(1.1);
    }

    .new-tab-btn:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body>
  <!-- Tab bar -->
  <div class="tab-bar" id="tabBar">
    <div class="tab active" data-tab-id="0" draggable="true">
      <span class="tab-title" id="tab-title-0">New Tab</span>
      <span class="tab-close">Ã—</span>
    </div>
    <button class="new-tab-btn" id="newTabBtn">+</button>
  </div>

  <div class="browser-toolbar" id="toolbar">
    <button class="nav-button" id="backBtn" title="Back">â€¹</button>
    <button class="nav-button" id="forwardBtn" title="Forward">â€º</button>
    <button class="nav-button" id="refreshBtn" title="Reload">â†»</button>

    <div class="url-container">
      <span class="url-icon"></span>
      <input
        type="text"
        class="url-input"
        id="urlInput"
        placeholder="Search or enter a URL"
      />
    </div>

    <button class="chat-toggle-btn" id="chatToggleBtn" title="Toggle AI Chat">ğŸ’¬</button>
  </div>

  <!-- Chat UI iframe -->
  <iframe src="browser-chat-ui.html" class="chat-iframe" id="chatIframe"></iframe>

  <script>
    const { ipcRenderer } = require('electron');

    const backBtn = document.getElementById('backBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const urlInput = document.getElementById('urlInput');
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const chatIframe = document.getElementById('chatIframe');
    const toolbar = document.getElementById('toolbar');
    const tabBar = document.getElementById('tabBar');
    const newTabBtn = document.getElementById('newTabBtn');

    let chatVisible = true;
    let currentTabId = 0;
    let tabs = [{ id: 0, title: 'New Tab', url: 'https://www.google.com' }];
    let nextTabId = 1;

    // Chat í† ê¸€
    chatToggleBtn.addEventListener('click', () => {
      chatVisible = !chatVisible;

      if (chatVisible) {
        chatIframe.classList.remove('hidden');
        toolbar.classList.remove('full-width');
        tabBar.classList.remove('full-width');
        chatToggleBtn.textContent = 'ğŸ’¬';
        ipcRenderer.invoke('toggle-chat', { visible: true });
      } else {
        chatIframe.classList.add('hidden');
        toolbar.classList.add('full-width');
        tabBar.classList.add('full-width');
        chatToggleBtn.textContent = 'ğŸ’¬';
        ipcRenderer.invoke('toggle-chat', { visible: false });
      }
    });

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ ë³€ìˆ˜
    let draggedTab = null;
    let draggedTabId = null;

    // íƒ­ ìƒì„±
    function createNewTab() {
      const tabId = nextTabId++;
      tabs.push({ id: tabId, title: 'New Tab', url: 'https://www.google.com' });

      const tabElement = document.createElement('div');
      tabElement.className = 'tab';
      tabElement.setAttribute('data-tab-id', tabId);
      tabElement.setAttribute('draggable', 'true');
      tabElement.innerHTML = `
        <span class="tab-title" id="tab-title-${tabId}">New Tab</span>
        <span class="tab-close">Ã—</span>
      `;

      tabElement.addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-close')) {
          closeTab(tabId);
        } else {
          switchTab(tabId);
        }
      });

      // ë“œë˜ê·¸ ì´ë²¤íŠ¸
      setupTabDragEvents(tabElement, tabId);

      tabBar.insertBefore(tabElement, newTabBtn);
      switchTab(tabId);
    }

    // íƒ­ ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì„¤ì •
    function setupTabDragEvents(tabElement, tabId) {
      tabElement.addEventListener('dragstart', (e) => {
        draggedTab = tabElement;
        draggedTabId = tabId;
        tabElement.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });

      tabElement.addEventListener('dragend', (e) => {
        tabElement.classList.remove('dragging');
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('drag-over'));
      });

      tabElement.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (draggedTab && draggedTab !== tabElement) {
          tabElement.classList.add('drag-over');
        }
      });

      tabElement.addEventListener('dragleave', (e) => {
        tabElement.classList.remove('drag-over');
      });

      tabElement.addEventListener('drop', (e) => {
        e.preventDefault();
        tabElement.classList.remove('drag-over');

        if (draggedTab && draggedTab !== tabElement) {
          // ë°°ì—´ì—ì„œ íƒ­ ìˆœì„œ ë³€ê²½
          const draggedIndex = tabs.findIndex(t => t.id === draggedTabId);
          const targetIndex = tabs.findIndex(t => t.id === tabId);

          if (draggedIndex !== -1 && targetIndex !== -1) {
            const [movedTab] = tabs.splice(draggedIndex, 1);
            tabs.splice(targetIndex, 0, movedTab);

            // DOMì—ì„œ ìˆœì„œ ë³€ê²½
            const targetTab = tabElement;
            if (draggedIndex < targetIndex) {
              targetTab.parentNode.insertBefore(draggedTab, targetTab.nextSibling);
            } else {
              targetTab.parentNode.insertBefore(draggedTab, targetTab);
            }
          }
        }
      });
    }

    // íƒ­ ì „í™˜
    function switchTab(tabId) {
      currentTabId = tabId;

      // UI ì—…ë°ì´íŠ¸
      document.querySelectorAll('.tab').forEach(tab => {
        if (parseInt(tab.getAttribute('data-tab-id')) === tabId) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      // íƒ­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const tab = tabs.find(t => t.id === tabId);
      if (tab) {
        ipcRenderer.invoke('switch-tab', { tabId, url: tab.url });
      }
    }

    // íƒ­ ë‹«ê¸°
    function closeTab(tabId) {
      if (tabs.length === 1) {
        alert('The last tab cannot be closed.');
        return;
      }

      // íƒ­ ì œê±°
      tabs = tabs.filter(t => t.id !== tabId);
      const tabElement = tabBar.querySelector(`[data-tab-id="${tabId}"]`);
      if (tabElement) {
        tabElement.remove();
      }

      // í˜„ì¬ íƒ­ì´ ë‹«íŒ ê²½ìš° ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì „í™˜
      if (currentTabId === tabId) {
        switchTab(tabs[0].id);
      }
    }

    // ìƒˆ íƒ­ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    newTabBtn.addEventListener('click', createNewTab);

    // ì²« íƒ­ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelector('.tab').addEventListener('click', (e) => {
      if (e.target.classList.contains('tab-close')) {
        closeTab(0);
      } else {
        switchTab(0);
      }
    });

    // ë’¤ë¡œ ê°€ê¸°
    backBtn.addEventListener('click', () => {
      ipcRenderer.invoke('browser-navigation', { action: 'back' });
    });

    // ì•ìœ¼ë¡œ ê°€ê¸°
    forwardBtn.addEventListener('click', () => {
      ipcRenderer.invoke('browser-navigation', { action: 'forward' });
    });

    // ìƒˆë¡œê³ ì¹¨
    refreshBtn.addEventListener('click', () => {
      ipcRenderer.invoke('browser-navigation', { action: 'reload' });
    });

    // URL ì…ë ¥ (Enter í‚¤)
    urlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        let url = urlInput.value.trim();

        // URLì´ ì•„ë‹ˆë©´ Google ê²€ìƒ‰ìœ¼ë¡œ ì²˜ë¦¬
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          if (url.includes('.') && !url.includes(' ')) {
            // domain.com í˜•íƒœë©´ https ì¶”ê°€
            url = 'https://' + url;
          } else {
            // ê²€ìƒ‰ì–´ë¡œ ì²˜ë¦¬
            url = 'https://www.google.com/search?q=' + encodeURIComponent(url);
          }
        }

        ipcRenderer.invoke('browser-navigation', { action: 'navigate', url });
      }
    });

    // BrowserView URL ë³€ê²½ ì‹œ ì£¼ì†Œì°½ ì—…ë°ì´íŠ¸
    ipcRenderer.on('url-changed', (event, url, title) => {
      urlInput.value = url;

      // í˜„ì¬ íƒ­ ì •ë³´ ì—…ë°ì´íŠ¸
      const currentTab = tabs.find(t => t.id === currentTabId);
      if (currentTab) {
        currentTab.url = url;
        currentTab.title = title || 'New Tab';

        // íƒ­ ì œëª© ì—…ë°ì´íŠ¸
        const tabTitleElement = document.getElementById(`tab-title-${currentTabId}`);
        if (tabTitleElement) {
          tabTitleElement.textContent = title || 'New Tab';
        }
      }

      // ë’¤ë¡œ/ì•ìœ¼ë¡œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      ipcRenderer.invoke('browser-can-navigate').then(({ canGoBack, canGoForward }) => {
        backBtn.disabled = !canGoBack;
        forwardBtn.disabled = !canGoForward;
      });
    });

    // Forward agent events to chat iframe
    ipcRenderer.on('agent-started', (event, data) => {
      chatIframe.contentWindow.postMessage({ type: 'agent-started', data }, '*');
    });

    ipcRenderer.on('agent-log', (event, data) => {
      chatIframe.contentWindow.postMessage({ type: 'agent-log', data }, '*');
    });

    ipcRenderer.on('agent-stopped', (event, data) => {
      chatIframe.contentWindow.postMessage({ type: 'agent-stopped', data }, '*');
    });

    ipcRenderer.on('agent-screenshot', (event, data) => {
      chatIframe.contentWindow.postMessage({ type: 'agent-screenshot', data }, '*');
    });

    // ì´ˆê¸° íƒ­ì— ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì„¤ì •
    const initialTab = document.querySelector('.tab[data-tab-id="0"]');
    if (initialTab) {
      setupTabDragEvents(initialTab, 0);
    }

    // ì´ˆê¸° URL ë¡œë“œ
    ipcRenderer.invoke('browser-get-url').then((url) => {
      if (url) urlInput.value = url;
    });
  </script>
</body>
</html>
