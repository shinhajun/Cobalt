<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cobalt</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }

    .browser-toolbar {
      position: fixed;
      top: 32px; /* Tab bar ë°”ë¡œ ì•„ë˜ */
      left: 0;
      width: 75%; /* ì™¼ìª½ 75% - BrowserView ì˜ì—­ */
      height: 40px;
      background: #fff;
      border-bottom: 1px solid #dadce0;
      display: flex;
      align-items: center;
      padding: 0 8px;
      gap: 8px;
      z-index: 10000;
    }

    .nav-button {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5f6368;
      font-size: 24px;
      font-weight: 300;
      transition: background 0.15s, transform 0.1s;
    }

    .nav-button:hover:not(:disabled) {
      background: #e8eaed;
      transform: scale(1.05);
    }

    .nav-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .nav-button:active:not(:disabled) {
      background: #dadce0;
      transform: scale(0.95);
    }

    .url-container {
      flex: 1;
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid #dadce0;
      border-radius: 24px;
      padding: 0 16px;
      height: 36px;
    }

    .url-container:focus-within {
      background: white;
      box-shadow: 0 1px 6px rgba(32,33,36,.28);
    }

    .url-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      color: #202124;
      background: transparent;
    }

    .url-icon {
      margin-right: 8px;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: #5f6368;
    }

    .url-icon svg {
      width: 16px;
      height: 16px;
    }

    .chat-toggle-btn {
      border: none;
      background: white;
      border-radius: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px 14px;
      margin-left: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #667eea;
      letter-spacing: 0.3px;
      transition: all 0.3s ease;
      position: relative;
      box-shadow: 0 0 0 2px transparent;
      height: 28px;
    }

    .chat-toggle-btn::before {
      content: '';
      position: absolute;
      top: -1.5px;
      left: -1.5px;
      right: -1.5px;
      bottom: -1.5px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      z-index: -1;
    }

    .chat-toggle-btn:hover {
      box-shadow: 0 2px 12px rgba(102, 126, 234, 0.25);
    }

    .chat-toggle-btn:active {
      box-shadow: 0 1px 4px rgba(102, 126, 234, 0.2);
    }

    /* Chat UI iframe - ì˜¤ë¥¸ìª½ 25% */
    .chat-iframe {
      position: fixed;
      right: 0;
      top: 0; /* ë§¨ ìœ„ë¶€í„° ì‹œì‘ (ì±„íŒ… íƒ­ë°”ë„ ìƒë‹¨ 32pxì— í¬í•¨) */
      width: 25%;
      height: 100vh;
      border: none;
      z-index: 1000;
      transition: transform 0.15s ease-out, opacity 0.15s ease-out;
    }

    .chat-iframe.hidden {
      transform: translateX(100%);
      opacity: 0;
      pointer-events: none;
    }

    /* Toolbar í¬ê¸° ì¡°ì • - chat ìˆ¨ê¸°ë©´ 100% */
    .browser-toolbar.full-width {
      width: 100%;
    }

    /* Tab bar */
    .tab-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%; /* ì „ì²´ ë„ˆë¹„ */
      height: 32px;
      background: #e8eaed;
      display: flex;
      align-items: center;
      gap: 0; /* ë¸Œëœë“œì™€ íƒ­ ì‚¬ì´ êµ¬ë¶„ */
      padding: 0;
      padding-right: 150px; /* ìœˆë„ìš° ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ê³µê°„ í™•ë³´ */
      overflow-x: auto;
      overflow-y: hidden;
      z-index: 10001;
      -webkit-app-region: drag; /* íƒ€ì´í‹€ë°”ì²˜ëŸ¼ ë“œë˜ê·¸ ê°€ëŠ¥ */
    }

    /* Cobalt ë¸Œëœë“œ ë¡œê³  */
    .cobalt-brand {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 16px;
      height: 100%;
      background: transparent;
      border-right: 1px solid #dadce0;
      flex-shrink: 0; /* í¬ê¸° ê³ ì • */
      -webkit-app-region: drag; /* ë“œë˜ê·¸ ê°€ëŠ¥ */
    }

    .cobalt-logo {
      width: 20px;
      height: 20px;
      object-fit: contain;
    }

    .cobalt-text {
      font-size: 14px;
      font-weight: 600;
      color: #202124;
      letter-spacing: 0.5px;
      user-select: none;
    }

    /* íƒ­ ì»¨í…Œì´ë„ˆ */
    .tabs-container {
      display: flex;
      align-items: center;
      gap: 2px;
      padding: 0 4px;
      flex: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
      overflow-x: auto;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: transparent;
      cursor: grab;
      width: 180px;
      font-size: 13px;
      color: #5f6368;
      user-select: none;
      transition: background 0.15s, transform 0.15s, box-shadow 0.15s;
      position: relative;
      -webkit-app-region: no-drag; /* íƒ­ì€ í´ë¦­ ê°€ëŠ¥ */
    }

    .tab:not(.active)::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 1px;
      height: 16px;
      background: #dadce0;
    }

    .tab:hover:not(.active) {
      background: #e8eaed;
    }

    .tab.active {
      background: #fff;
      color: #202124;
      border-radius: 8px 8px 0 0;
      border-top: 1px solid #dadce0;
      border-left: 1px solid #dadce0;
      border-right: 1px solid #dadce0;
      border-bottom: 1px solid #fff;
      position: relative;
      z-index: 1;
    }

    .tab.active::after {
      display: none;
    }

    .tab.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .tab.drag-over {
      transform: translateX(4px);
    }

    .tab-favicon {
      width: 16px;
      height: 16px;
      object-fit: contain;
      flex-shrink: 0;
    }

    .tab-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .tab-close {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      opacity: 0.6;
      transition: opacity 0.2s, background 0.2s;
    }

    .tab-close:hover {
      opacity: 1;
      background: rgba(0,0,0,0.1);
    }

    .new-tab-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #3c4043;
      transition: background 0.15s, transform 0.15s;
      -webkit-app-region: no-drag; /* ë²„íŠ¼ì€ í´ë¦­ ê°€ëŠ¥ */
    }

    .new-tab-btn:hover {
      background: rgba(255,255,255,0.4);
      transform: scale(1.1);
    }

    .new-tab-btn:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body>
  <!-- Tab bar -->
  <div class="tab-bar" id="tabBar">
    <!-- Cobalt ë¸Œëœë“œ ë¡œê³  -->
    <div class="cobalt-brand">
      <img src="cobalt_logo.png" alt="Cobalt" class="cobalt-logo">
      <span class="cobalt-text">Cobalt</span>
    </div>

    <!-- íƒ­ ì»¨í…Œì´ë„ˆ -->
    <div class="tabs-container" id="tabsContainer">
      <div class="tab active" data-tab-id="0" draggable="true">
        <img class="tab-favicon" id="tab-favicon-0" src="cobalt_logo.png" alt="">
        <span class="tab-title" id="tab-title-0">New Tab</span>
        <span class="tab-close">Ã—</span>
      </div>
      <button class="new-tab-btn" id="newTabBtn">+</button>
    </div>
  </div>

  <div class="browser-toolbar" id="toolbar">
    <button class="nav-button" id="backBtn" title="Back">â€¹</button>
    <button class="nav-button" id="forwardBtn" title="Forward">â€º</button>
    <button class="nav-button" id="refreshBtn" title="Reload">â†»</button>

    <div class="url-container">
      <span class="url-icon" id="urlIcon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="5" y="11" width="14" height="10" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
      </span>
      <input
        type="text"
        class="url-input"
        id="urlInput"
        placeholder="Search or enter a URL"
      />
    </div>

    <button class="chat-toggle-btn" id="chatToggleBtn" title="Toggle AI Chat">
      AI Chat
    </button>
  </div>

  <!-- Chat UI iframe -->
  <iframe src="browser-chat-ui.html" class="chat-iframe hidden" id="chatIframe"></iframe>

  <script>
    const { ipcRenderer } = require('electron');

    const backBtn = document.getElementById('backBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const urlInput = document.getElementById('urlInput');
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const chatIframe = document.getElementById('chatIframe');
    const toolbar = document.getElementById('toolbar');
    const tabBar = document.getElementById('tabBar');
    const tabsContainer = document.getElementById('tabsContainer');
    const newTabBtn = document.getElementById('newTabBtn');

    let chatVisible = false;
    let currentTabId = 0;
    // ì´ˆê¸° íƒ­ì˜ URLì„ ì ˆëŒ€ ê²½ë¡œë¡œ ì„¤ì •
    const homePageUrl = `file:///${__dirname.replace(/\\/g, '/')}/cobalt-home.html`;
    // ì´ˆê¸° íƒ­ì€ Cobalt ë¡œê³ ë¡œ ì‹œì‘
    let tabs = [{ id: 0, title: 'New Tab', url: homePageUrl, favicon: 'cobalt_logo.png' }];
    let nextTabId = 1;

    // ê¸°ë³¸ favicon (ë¹ˆ í˜ì´ì§€ìš©)
    const defaultFavicon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext x='8' y='12' text-anchor='middle' font-size='12'%3EğŸ“„%3C/text%3E%3C/svg%3E";

    // Favicon ì¶”ì¶œ í•¨ìˆ˜
    function getFaviconUrl(url) {
      try {
        const urlObj = new URL(url);
        if (urlObj.protocol === 'about:' || urlObj.protocol === 'file:') {
          return defaultFavicon;
        }
        return `https://www.google.com/s2/favicons?domain=${urlObj.hostname}&sz=32`;
      } catch {
        return defaultFavicon;
      }
    }

    // ì´ˆê¸° ìƒíƒœ ì„¤ì • (ì±„íŒ… ë‹«íŒ ìƒíƒœ)
    toolbar.classList.add('full-width');

    // Chat í† ê¸€
    chatToggleBtn.addEventListener('click', () => {
      chatVisible = !chatVisible;

      if (chatVisible) {
        chatIframe.classList.remove('hidden');
        toolbar.classList.remove('full-width');
        tabBar.classList.remove('full-width');
        ipcRenderer.invoke('toggle-chat', { visible: true });
      } else {
        chatIframe.classList.add('hidden');
        toolbar.classList.add('full-width');
        tabBar.classList.add('full-width');
        ipcRenderer.invoke('toggle-chat', { visible: false });
      }
    });

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ ë³€ìˆ˜
    let draggedTab = null;
    let draggedTabId = null;
    let isCreatingTab = false; // Prevent duplicate tab creation

    // íƒ­ ìƒì„±
    function createNewTab() {
      // Prevent duplicate calls
      if (isCreatingTab) {
        console.warn('[Toolbar] Tab creation already in progress, ignoring duplicate call');
        return;
      }

      isCreatingTab = true;

      try {
        const tabId = nextTabId++;
        console.log('[Toolbar] Creating new tab with ID:', tabId);
        console.log('[Toolbar] Current tabs before creation:', tabs.map(t => ({ id: t.id, title: t.title })));

        // Check if tab already exists in DOM
        const existingTab = document.querySelector(`[data-tab-id="${tabId}"]`);
        if (existingTab) {
          console.error('[Toolbar] Tab with ID', tabId, 'already exists in DOM! Aborting.');
          nextTabId--; // Rollback ID
          return;
        }

        // Check if tab already exists in array
        const existingInArray = tabs.find(t => t.id === tabId);
        if (existingInArray) {
          console.error('[Toolbar] Tab with ID', tabId, 'already exists in array! Aborting.');
          nextTabId--; // Rollback ID
          return;
        }

        // ìƒˆ íƒ­ë„ Cobalt ë¡œê³ ë¡œ ì‹œì‘
        tabs.push({ id: tabId, title: 'New Tab', url: homePageUrl, favicon: 'cobalt_logo.png' });
        console.log('[Toolbar] Tab added to array. Total tabs:', tabs.length);

        const tabElement = document.createElement('div');
        tabElement.className = 'tab';
        tabElement.setAttribute('data-tab-id', tabId);
        tabElement.setAttribute('draggable', 'true');
        tabElement.innerHTML = `
          <img class="tab-favicon" id="tab-favicon-${tabId}" src="cobalt_logo.png" alt="">
          <span class="tab-title" id="tab-title-${tabId}">New Tab</span>
          <span class="tab-close">Ã—</span>
        `;

        tabElement.addEventListener('click', (e) => {
          if (e.target.classList.contains('tab-close')) {
            closeTab(tabId);
          } else {
            switchTab(tabId);
          }
        });

        // ë“œë˜ê·¸ ì´ë²¤íŠ¸
        setupTabDragEvents(tabElement, tabId);

        tabsContainer.insertBefore(tabElement, newTabBtn);
        console.log('[Toolbar] Tab element added to DOM. DOM tabs count:', document.querySelectorAll('.tab').length);

        switchTab(tabId);
      } finally {
        // Reset flag after a short delay to allow the operation to complete
        setTimeout(() => {
          isCreatingTab = false;
        }, 100);
      }
    }

    // íƒ­ ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì„¤ì •
    function setupTabDragEvents(tabElement, tabId) {
      tabElement.addEventListener('dragstart', (e) => {
        draggedTab = tabElement;
        draggedTabId = tabId;
        tabElement.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });

      tabElement.addEventListener('dragend', (e) => {
        tabElement.classList.remove('dragging');
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('drag-over'));
      });

      tabElement.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (draggedTab && draggedTab !== tabElement) {
          tabElement.classList.add('drag-over');
        }
      });

      tabElement.addEventListener('dragleave', (e) => {
        tabElement.classList.remove('drag-over');
      });

      tabElement.addEventListener('drop', (e) => {
        e.preventDefault();
        tabElement.classList.remove('drag-over');

        if (draggedTab && draggedTab !== tabElement) {
          // ë°°ì—´ì—ì„œ íƒ­ ìˆœì„œ ë³€ê²½
          const draggedIndex = tabs.findIndex(t => t.id === draggedTabId);
          const targetIndex = tabs.findIndex(t => t.id === tabId);

          if (draggedIndex !== -1 && targetIndex !== -1) {
            const [movedTab] = tabs.splice(draggedIndex, 1);
            tabs.splice(targetIndex, 0, movedTab);

            // DOMì—ì„œ ìˆœì„œ ë³€ê²½
            const targetTab = tabElement;
            if (draggedIndex < targetIndex) {
              targetTab.parentNode.insertBefore(draggedTab, targetTab.nextSibling);
            } else {
              targetTab.parentNode.insertBefore(draggedTab, targetTab);
            }
          }
        }
      });
    }

    // íƒ­ ì „í™˜
    function switchTab(tabId) {
      console.log('[Toolbar] Switching to tab:', tabId);
      console.log('[Toolbar] Current tab before switch:', currentTabId);

      currentTabId = tabId;

      // UI ì—…ë°ì´íŠ¸
      document.querySelectorAll('.tab').forEach(tab => {
        const tabIdAttr = parseInt(tab.getAttribute('data-tab-id'));
        if (tabIdAttr === tabId) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      // íƒ­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const tab = tabs.find(t => t.id === tabId);
      if (!tab) {
        console.error('[Toolbar] Tab not found in array:', tabId);
        return;
      }

      console.log('[Toolbar] Tab info:', { id: tab.id, title: tab.title, url: tab.url });

      if (tab.url) {
        // URLì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
        const urlToLoad = tab.url.startsWith('http') || tab.url.startsWith('file://')
          ? tab.url
          : homePageUrl;

        console.log('[Toolbar] Invoking switch-tab with URL:', urlToLoad);
        ipcRenderer.invoke('switch-tab', { tabId, url: urlToLoad })
          .then(() => {
            console.log('[Toolbar] Successfully switched to tab:', tabId);
          })
          .catch(err => {
            console.error('[Toolbar] Failed to switch tab:', err);
          });
      }
    }

    // íƒ­ ë‹«ê¸°
    function closeTab(tabId) {
      console.log('[Toolbar] Closing tab:', tabId);
      console.log('[Toolbar] Current tabs before close:', tabs.map(t => ({ id: t.id, title: t.title })));

      if (tabs.length === 1) {
        alert('The last tab cannot be closed.');
        return;
      }

      // Notify electron to destroy the BrowserView
      ipcRenderer.invoke('close-tab', { tabId }).catch(err => {
        console.error('[Toolbar] Failed to close tab in electron:', err);
      });

      // íƒ­ ì œê±°
      tabs = tabs.filter(t => t.id !== tabId);
      const tabElement = tabBar.querySelector(`[data-tab-id="${tabId}"]`);
      if (tabElement) {
        tabElement.remove();
        console.log('[Toolbar] Tab element removed from DOM');
      }

      console.log('[Toolbar] Tabs after close:', tabs.map(t => ({ id: t.id, title: t.title })));
      console.log('[Toolbar] DOM tabs count:', document.querySelectorAll('.tab').length);

      // í˜„ì¬ íƒ­ì´ ë‹«íŒ ê²½ìš° ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì „í™˜
      if (currentTabId === tabId) {
        const nextTab = tabs[tabs.length - 1]; // Switch to last tab
        if (nextTab) {
          console.log('[Toolbar] Switching to tab:', nextTab.id);
          switchTab(nextTab.id);
        }
      }
    }

    // Initialize first tab with event listeners
    function initializeFirstTab() {
      const firstTab = document.querySelector('.tab[data-tab-id="0"]');
      if (firstTab) {
        // Remove any existing listeners by cloning
        const newFirstTab = firstTab.cloneNode(true);
        firstTab.parentNode.replaceChild(newFirstTab, firstTab);

        // Add click event
        newFirstTab.addEventListener('click', (e) => {
          if (e.target.classList.contains('tab-close')) {
            closeTab(0);
          } else {
            switchTab(0);
          }
        });

        // Add drag events
        setupTabDragEvents(newFirstTab, 0);

        console.log('[Toolbar] First tab initialized');
      }
    }

    // Initialize first tab
    initializeFirstTab();

    // ìƒˆ íƒ­ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    newTabBtn.addEventListener('click', createNewTab);

    // ë’¤ë¡œ ê°€ê¸°
    backBtn.addEventListener('click', () => {
      ipcRenderer.invoke('browser-navigation', { action: 'back' });
    });

    // ì•ìœ¼ë¡œ ê°€ê¸°
    forwardBtn.addEventListener('click', () => {
      ipcRenderer.invoke('browser-navigation', { action: 'forward' });
    });

    // ìƒˆë¡œê³ ì¹¨
    refreshBtn.addEventListener('click', () => {
      ipcRenderer.invoke('browser-navigation', { action: 'reload' });
    });

    // URL ì…ë ¥ (Enter í‚¤)
    urlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        let url = urlInput.value.trim();

        // ì£¼ì†Œì°½ì´ ë¹„ì–´ìˆìœ¼ë©´ í™ˆ í˜ì´ì§€ë¡œ ì´ë™
        if (!url) {
          ipcRenderer.invoke('browser-navigation', { action: 'navigate', url: homePageUrl });
          return;
        }

        // URLì´ ì•„ë‹ˆë©´ Google ê²€ìƒ‰ìœ¼ë¡œ ì²˜ë¦¬
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          if (url.includes('.') && !url.includes(' ')) {
            // domain.com í˜•íƒœë©´ https ì¶”ê°€
            url = 'https://' + url;
          } else {
            // ê²€ìƒ‰ì–´ë¡œ ì²˜ë¦¬
            url = 'https://www.google.com/search?q=' + encodeURIComponent(url);
          }
        }

        ipcRenderer.invoke('browser-navigation', { action: 'navigate', url });
      }
    });

    // BrowserView URL ë³€ê²½ ì‹œ ì£¼ì†Œì°½ ì—…ë°ì´íŠ¸
    ipcRenderer.on('url-changed', (event, url, title) => {
      // cobalt-home.htmlì¼ ë•ŒëŠ” ì£¼ì†Œì°½ì„ ë¹„ì›Œì„œ ê¹”ë”í•˜ê²Œ í‘œì‹œ
      const isCobaltHome = url.includes('cobalt-home.html');
      if (isCobaltHome) {
        urlInput.value = '';
      } else {
        urlInput.value = url;
      }

      // í˜„ì¬ íƒ­ ì •ë³´ ì—…ë°ì´íŠ¸
      const currentTab = tabs.find(t => t.id === currentTabId);
      if (currentTab) {
        currentTab.url = url;
        currentTab.title = title || 'New Tab';

        // Favicon ì—…ë°ì´íŠ¸ - cobalt-homeì´ë©´ ë¡œê³  ì‚¬ìš©
        const faviconUrl = isCobaltHome ? 'cobalt_logo.png' : getFaviconUrl(url);
        currentTab.favicon = faviconUrl;

        // íƒ­ ì œëª© ì—…ë°ì´íŠ¸
        const tabTitleElement = document.getElementById(`tab-title-${currentTabId}`);
        if (tabTitleElement) {
          tabTitleElement.textContent = title || 'New Tab';
        }

        // Favicon ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
        const tabFaviconElement = document.getElementById(`tab-favicon-${currentTabId}`);
        if (tabFaviconElement) {
          tabFaviconElement.src = faviconUrl;
        }
      }

      // ë’¤ë¡œ/ì•ìœ¼ë¡œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      ipcRenderer.invoke('browser-can-navigate').then(({ canGoBack, canGoForward }) => {
        backBtn.disabled = !canGoBack;
        forwardBtn.disabled = !canGoForward;
      });
    });

    // Forward agent events to chat iframe
    ipcRenderer.on('agent-started', (event, data) => {
      chatIframe.contentWindow.postMessage({ type: 'agent-started', data }, '*');
    });

    ipcRenderer.on('agent-log', (event, data) => {
      chatIframe.contentWindow.postMessage({ type: 'agent-log', data }, '*');
    });

    ipcRenderer.on('agent-stopped', (event, data) => {
      chatIframe.contentWindow.postMessage({ type: 'agent-stopped', data }, '*');
    });

    ipcRenderer.on('agent-screenshot', (event, data) => {
      chatIframe.contentWindow.postMessage({ type: 'agent-screenshot', data }, '*');
    });

    // Note: Legacy translate-text and ai-edit-text event handlers removed
    // These were unused - actual translation/editing handled via browserview-* IPC channels

    // Handle execute-home-search event
    console.log('[Toolbar] Registering execute-home-search listener');
    ipcRenderer.on('execute-home-search', async (event, query) => {
      console.log('[Toolbar] Execute home search received');
      console.log('[Toolbar] Query value:', query);
      console.log('[Toolbar] Query type:', typeof query);
      console.log('[Toolbar] Current chatVisible:', chatVisible);

      console.log('[Toolbar] Chat iframe found:', !!chatIframe);

      // Show chat if hidden
      if (!chatVisible) {
        console.log('[Toolbar] Opening chat...');
        chatVisible = true;
        chatIframe.classList.remove('hidden');
        toolbar.classList.remove('full-width');
        tabBar.classList.remove('full-width');
        await ipcRenderer.invoke('toggle-chat', { visible: true });
        console.log('[Toolbar] Chat opened, chatVisible now:', chatVisible);
      } else {
        console.log('[Toolbar] Chat already visible');
      }

      // Wait a bit for chat to be visible
      setTimeout(() => {
        console.log('[Toolbar] Sending execute-search to chat iframe');
        console.log('[Toolbar] Query being sent:', query);

        if (!chatIframe.contentWindow) {
          console.error('[Toolbar] Chat iframe contentWindow not available');
          return;
        }

        // Send message to chat iframe to create new tab and execute query
        chatIframe.contentWindow.postMessage({
          type: 'execute-search',
          query: query
        }, '*');
        console.log('[Toolbar] Message sent to chat iframe');
      }, 300);
    });

    // Handle tab-switched event from main process
    ipcRenderer.on('tab-switched', (event, { tabId }) => {
      console.log('[Toolbar] Tab switched event received, tabId:', tabId);

      // Update current tab ID
      currentTabId = tabId;

      // Update tab UI - remove active from all tabs, add to current
      document.querySelectorAll('.tab').forEach(tab => {
        const tabIdAttr = parseInt(tab.getAttribute('data-tab-id'));
        if (tabIdAttr === tabId) {
          tab.classList.add('active');
          console.log('[Toolbar] Set tab', tabId, 'as active');
        } else {
          tab.classList.remove('active');
        }
      });
    });

    // Handle create-new-tab event from main process (when user clicks links with target="_blank")
    ipcRenderer.on('create-new-tab', (event, { tabId, url }) => {
      console.log('[Toolbar] Create new tab event received, tabId:', tabId, 'url:', url);

      // Check if tab already exists
      const existingTab = tabs.find(t => t.id === tabId);
      if (existingTab) {
        console.log('[Toolbar] Tab already exists, switching to it');
        switchTab(tabId);
        return;
      }

      // Create new tab with the URL
      tabs.push({ id: tabId, title: 'Loading...', url: url, favicon: defaultFavicon });
      console.log('[Toolbar] Tab added to array. Total tabs:', tabs.length);

      const tabElement = document.createElement('div');
      tabElement.className = 'tab';
      tabElement.setAttribute('data-tab-id', tabId);
      tabElement.setAttribute('draggable', 'true');
      tabElement.innerHTML = `
        <img class="tab-favicon" id="tab-favicon-${tabId}" src="${defaultFavicon}" alt="">
        <span class="tab-title" id="tab-title-${tabId}">Loading...</span>
        <span class="tab-close">Ã—</span>
      `;

      tabElement.addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-close')) {
          closeTab(tabId);
        } else {
          switchTab(tabId);
        }
      });

      // Setup drag events
      setupTabDragEvents(tabElement, tabId);

      tabsContainer.insertBefore(tabElement, newTabBtn);
      console.log('[Toolbar] Tab element added to DOM. DOM tabs count:', document.querySelectorAll('.tab').length);

      // Switch to the new tab and load the URL
      switchTab(tabId, url);
    });

    // ì´ˆê¸° íƒ­ì— ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì„¤ì •
    const initialTab = document.querySelector('.tab[data-tab-id="0"]');
    if (initialTab) {
      setupTabDragEvents(initialTab, 0);
    }

    // ì´ˆê¸° URL ë¡œë“œ
    ipcRenderer.invoke('browser-get-url').then((url) => {
      if (url) urlInput.value = url;
    });
  </script>
</body>
</html>
